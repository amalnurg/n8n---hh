// Ð Ð•Ð–Ð˜Ðœ Ð ÐÐ‘ÐžÐ¢Ð« - Ð¢ÐžÐ›Ð¬ÐšÐž Ð¡Ð’Ð•Ð–Ð˜Ð• Ð’ÐÐšÐÐÐ¡Ð˜Ð˜ Ð—Ð ÐŸÐžÐ¡Ð›Ð•Ð”ÐÐ˜Ð™ Ð§ÐÐ¡
const DEBUG_MODE = false;

// Ð¤ÑƒÐ½ÐºÑ†Ð¸Ñ Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ¸ HH.ru Ð²Ð°ÐºÐ°Ð½ÑÐ¸Ð¹
function processHHVacancies(vacancies) {
  return vacancies.map(vacancy => ({
    ...vacancy,
    source: 'HH.ru'
  }));
}

// ÐžÐ±Ñ€Ð°Ð±Ð°Ñ‚Ñ‹Ð²Ð°ÐµÐ¼ Ð´Ð°Ð½Ð½Ñ‹Ðµ Ð¾Ñ‚ Ð²ÑÐµÑ… Ð¸ÑÑ‚Ð¾Ñ‡Ð½Ð¸ÐºÐ¾Ð²
let allVacancies = [];

// ÐžÐ±Ñ€Ð°Ð±Ð°Ñ‚Ñ‹Ð²Ð°ÐµÐ¼ HH.ru (items[0])
if (items[0]?.json?.items) {
  const hhVacancies = processHHVacancies(items[0].json.items);
  allVacancies = allVacancies.concat(hhVacancies);
}

console.log(`ðŸ“Š ÐŸÐ¾Ð»ÑƒÑ‡ÐµÐ½Ð¾ Ð²Ð°ÐºÐ°Ð½ÑÐ¸Ð¹ Ð¾Ñ‚ HH.ru: ${allVacancies.length}`);

// Ð¤Ð˜Ð›Ð¬Ð¢Ð Ð£Ð•Ðœ ÐŸÐžÐ¡Ð›Ð•Ð”ÐÐ˜Ð™ Ð§ÐÐ¡
const oneHourAgo = new Date(Date.now() - 1 * 60 * 60 * 1000);
const freshVacancies = allVacancies.filter(vacancy => {
  return new Date(vacancy.published_at) > oneHourAgo;
});

console.log(`Ð—Ð° Ð¿Ð¾ÑÐ»ÐµÐ´Ð½Ð¸Ð¹ Ñ‡Ð°Ñ: ${freshVacancies.length}`);

// ÐšÐ»ÑŽÑ‡ÐµÐ²Ñ‹Ðµ ÑÐ»Ð¾Ð²Ð° Ð´Ð»Ñ Ð˜Ð¡ÐšÐ›Ð®Ð§Ð•ÐÐ˜Ð¯ (Ð²Ð°ÐºÐ°Ð½ÑÐ¸Ð¸ Ñ Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ð·Ð°Ñ†Ð¸ÐµÐ¹)
const excludeKeywords = [
  'Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ð·Ð°Ñ†Ð¸Ñ', 'automation', 'auto', 'Ð°Ð²Ñ‚Ð¾Ñ‚ÐµÑÑ‚', 'autotest',
  'java', 'python', 'javascript', 'selenium', 'cypress', 'playwright', 
  'qa auto', 'automated', 'Ñ++', 'c#', '.net', 'sql'
];

// Ð¤Ð¸Ð»ÑŒÑ‚Ñ€ÑƒÐµÐ¼ Ð¢ÐžÐ›Ð¬ÐšÐž Ñ€ÑƒÑ‡Ð½Ð¾Ðµ Ñ‚ÐµÑÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ
const manualOnlyVacancies = freshVacancies.filter(vacancy => {
  const vacancyName = vacancy.name.toLowerCase();
  const vacancyDescription = vacancy.description?.toLowerCase() || '';
  const hasAutomation = excludeKeywords.some(keyword => 
    vacancyName.includes(keyword) || vacancyDescription.includes(keyword)
  );
  return !hasAutomation;
});

console.log(`ðŸ”§ Ð ÑƒÑ‡Ð½Ð¾Ðµ Ñ‚ÐµÑÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ: ${manualOnlyVacancies.length}`);

// Ð”Ð•Ð”Ð£ÐŸÐ›Ð˜ÐšÐÐ¦Ð˜Ð¯ Ð¿Ð¾ ID
const seenIds = [];
const uniqueVacancies = manualOnlyVacancies.filter(vacancy => {
  if (seenIds.includes(vacancy.id)) return false;
  seenIds.push(vacancy.id);
  return true;
});

console.log(`âœ¨ Ð£Ð½Ð¸ÐºÐ°Ð»ÑŒÐ½Ñ‹Ðµ: ${uniqueVacancies.length}`);

// Ð¤Ð¾Ñ€Ð¼Ð°Ñ‚Ð¸Ñ€ÑƒÐµÐ¼ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ñ
const messages = uniqueVacancies.map(vacancy => {
  const salary = vacancy.salary ? 
    `${vacancy.salary.from || '?'}-${vacancy.salary.to || '?'} ${vacancy.salary.currency || 'RUR'}`.trim() : 
    'Ð·/Ð¿ Ð½Ðµ ÑƒÐºÐ°Ð·Ð°Ð½Ð°';
  
  return `ðŸ†• ÐÐžÐ’ÐÐ¯ Ð’ÐÐšÐÐÐ¡Ð˜Ð¯
ðŸ¢ ${vacancy.employer?.name || 'ÐšÐ¾Ð¼Ð¿Ð°Ð½Ð¸Ñ Ð½Ðµ ÑƒÐºÐ°Ð·Ð°Ð½Ð°'}
ðŸ“ ${vacancy.name}
ðŸ’° ${salary}
ðŸ“ ${vacancy.area?.name || 'Ð“Ð¾Ñ€Ð¾Ð´ Ð½Ðµ ÑƒÐºÐ°Ð·Ð°Ð½'}
ðŸ”— ${vacancy.alternate_url || 'Ð¡ÑÑ‹Ð»ÐºÐ° Ð½Ðµ ÑƒÐºÐ°Ð·Ð°Ð½Ð°'}
ðŸ“… ÐžÐ¿ÑƒÐ±Ð»Ð¸ÐºÐ¾Ð²Ð°Ð½Ð°: ${new Date(vacancy.published_at).toLocaleString('ru-RU', {day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit'})}
ðŸ“Š ${vacancy.source}`;
});

// Ð’Ð¡Ð•Ð“Ð”Ð Ð¾Ñ‚Ð¿Ñ€Ð°Ð²Ð»ÑÐµÐ¼ ÑƒÐ²ÐµÐ´Ð¾Ð¼Ð»ÐµÐ½Ð¸Ðµ
if (messages.length === 0) {
  console.log('âŒ ÐÐµÑ‚ Ð½Ð¾Ð²Ñ‹Ñ… Ð²Ð°ÐºÐ°Ð½ÑÐ¸Ð¹ Ð·Ð° Ð¿Ð¾ÑÐ»ÐµÐ´Ð½Ð¸Ð¹ Ñ‡Ð°Ñ');
  messages.push('ðŸ”´ Ð—Ð° Ð¿Ð¾ÑÐ»ÐµÐ´Ð½Ð¸Ð¹ Ñ‡Ð°Ñ Ð½Ð¾Ð²Ñ‹Ñ… Ð²Ð°ÐºÐ°Ð½ÑÐ¸Ð¹ Ð¿Ð¾ Ñ€ÑƒÑ‡Ð½Ð¾Ð¼Ñƒ Ñ‚ÐµÑÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸ÑŽ Ð½Ð° HH.ru Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½Ð¾!\n\nÐŸÐ¾ÐºÐ° Ð¸Ñ‰ÐµÐ¼ ÑÐ°Ð¼Ð¸ Ð½Ð° Ð´Ñ€ÑƒÐ³Ð¸Ñ… Ñ€ÐµÑÑƒÑ€ÑÐ°Ñ… ðŸ˜‰');
} else {
  console.log(`ðŸ“¤ ÐžÑ‚Ð¿Ñ€Ð°Ð²Ð»ÑÐµÐ¼ ${messages.length} Ð²Ð°ÐºÐ°Ð½ÑÐ¸Ð¹`);
}

// ÐžÐ“Ð ÐÐÐ˜Ð§Ð˜Ð’ÐÐ•Ðœ 20 Ð¡ÐžÐžÐ‘Ð©Ð•ÐÐ˜Ð™
const MAX_MESSAGES = 20;
const limitedMessages = messages.slice(0, MAX_MESSAGES);

// Ð’ÐžÐ—Ð’Ð ÐÐ©ÐÐ•Ðœ Ð¡ÐžÐžÐ‘Ð©Ð•ÐÐ˜Ð¯
return limitedMessages.map(message => ({ json: { message } }));
return limitedMessages.map(message => ({ 
  json: { 
    message: message,
    additionalFields: {
      disable_notification: true
    }
  } 
}));
